"use strict";(self.webpackChunkphysical_ai_humanoid_robotics_q2=self.webpackChunkphysical_ai_humanoid_robotics_q2||[]).push([[3231],{4429(n,e,a){a.r(e),a.d(e,{assets:()=>o,contentTitle:()=>r,default:()=>p,frontMatter:()=>t,metadata:()=>l,toc:()=>c});const l=JSON.parse('{"id":"chapters/vla-whisper-llm-planning","title":"Chapter 9 \u2014 VLA: Whisper + LLM Planning \u2192 ROS 2 Actions","description":"Learning Objectives","source":"@site/docs/chapters/09-vla-whisper-llm-planning.md","sourceDirName":"chapters","slug":"/chapters/vla-whisper-llm-planning","permalink":"/hackathon1/chapters/vla-whisper-llm-planning","draft":false,"unlisted":false,"editUrl":"https://github.com/mohammadfaisalpirzada/hackathon1/edit/main/docs/chapters/09-vla-whisper-llm-planning.md","tags":[],"version":"current","sidebarPosition":9,"frontMatter":{"title":"Chapter 9 \u2014 VLA: Whisper + LLM Planning \u2192 ROS 2 Actions"},"sidebar":"tutorialSidebar","previous":{"title":"Chapter 8 \u2014 Nav2 (Mapping, Localization, Navigation)","permalink":"/hackathon1/chapters/nav2"},"next":{"title":"Chapter 10 \u2014 Capstone Project","permalink":"/hackathon1/capstone"}}');var i=a(4848),s=a(8453);const t={title:"Chapter 9 \u2014 VLA: Whisper + LLM Planning \u2192 ROS 2 Actions"},r="Chapter 9 \u2014 VLA: Whisper + LLM Planning \u2192 ROS 2 Actions",o={},c=[{value:"Learning Objectives",id:"learning-objectives",level:2},{value:"Key Terms",id:"key-terms",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Concepts",id:"concepts",level:2},{value:"What \u201cVLA\u201d means in robotics",id:"what-vla-means-in-robotics",level:3},{value:"Safe interface: constrain outputs to a schema",id:"safe-interface-constrain-outputs-to-a-schema",level:3},{value:"Hands-on Lab (runnable): text command \u2192 validated plan \u2192 Nav2 goal",id:"hands-on-lab-runnable-text-command--validated-plan--nav2-goal",level:2},{value:"1) Create package",id:"1-create-package",level:3},{value:"2) Command input node (stdin \u2192 <code>/vla/command</code>)",id:"2-command-input-node-stdin--vlacommand",level:3},{value:"3) Planner node (validated plan \u2192 <code>/vla/plan</code>)",id:"3-planner-node-validated-plan--vlaplan",level:3},{value:"4) Nav2 executor (plan \u2192 <code>NavigateToPose</code>)",id:"4-nav2-executor-plan--navigatetopose",level:3},{value:"5) Register + build + run (with Nav2 running)",id:"5-register--build--run-with-nav2-running",level:3},{value:"Lab Deliverable",id:"lab-deliverable",level:2},{value:"Assessment Item",id:"assessment-item",level:2},{value:"Hands-on Lab (optional): add Whisper + an LLM planner",id:"hands-on-lab-optional-add-whisper--an-llm-planner",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Quick Quiz",id:"quick-quiz",level:2}];function d(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"chapter-9--vla-whisper--llm-planning--ros-2-actions",children:"Chapter 9 \u2014 VLA: Whisper + LLM Planning \u2192 ROS 2 Actions"})}),"\n",(0,i.jsx)(e.h2,{id:"learning-objectives",children:"Learning Objectives"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"Describe a safe voice/text-to-action pipeline: command \u2192 plan \u2192 validated actions."}),"\n",(0,i.jsx)(e.li,{children:"Implement a schema-constrained interface that prevents free-form LLM text from reaching actuators."}),"\n",(0,i.jsx)(e.li,{children:"Connect validated plans to ROS 2 actions (Nav2) and observe failures safely."}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"key-terms",children:"Key Terms"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"ASR, intent, schema validation, tool use, action server, safety constraints"}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"ROS 2 Humble."}),"\n",(0,i.jsx)(e.li,{children:"Nav2 lab working (Chapter 8) if you want real navigation goals."}),"\n",(0,i.jsx)(e.li,{children:"Python venv basics (we\u2019ll optionally install speech/LLM libs)."}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"concepts",children:"Concepts"}),"\n",(0,i.jsx)(e.h3,{id:"what-vla-means-in-robotics",children:"What \u201cVLA\u201d means in robotics"}),"\n",(0,i.jsx)(e.p,{children:"We\u2019ll use \u201cVLA\u201d as a practical pipeline:"}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"Speech \u2192 text"})," (Whisper-style ASR)"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"Text \u2192 plan"})," (LLM or rule-based planner)"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"Plan \u2192 structured robot actions"})," (ROS 2 actions/services/topics)"]}),"\n"]}),"\n",(0,i.jsxs)(e.p,{children:["Key rule: LLM output must be ",(0,i.jsx)(e.strong,{children:"validated"})," before it touches actuators."]}),"\n",(0,i.jsx)(e.mermaid,{value:'flowchart LR\n  Audio["Audio (optional)"] --\x3e ASR["ASR (Whisper-style)"]\n  ASR --\x3e Text["Text command"]\n  Text --\x3e Planner["Planner (LLM or rules)"]\n  Planner --\x3e Schema["Schema JSON (small)"]\n  Schema --\x3e Validator["Validator + safety gates"]\n  Validator --\x3e|allowed| Exec["Executor"]\n  Validator --\x3e|rejected| Fallback["Safe fallback (clarify/stop)"]\n  Exec --\x3e ROS["ROS 2 action/service/topic"]\n  ROS --\x3e Feedback["Feedback/result"]\n  Feedback --\x3e Planner'}),"\n",(0,i.jsx)(e.h3,{id:"safe-interface-constrain-outputs-to-a-schema",children:"Safe interface: constrain outputs to a schema"}),"\n",(0,i.jsx)(e.p,{children:"Instead of \u201cfree-form text\u201d, define a small command schema:"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-text",children:"NAVIGATE(goal_id: string)\nSAY(text: string)\nSTOP()\n"})}),"\n",(0,i.jsx)(e.p,{children:"Then implement:"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"parser + validator"}),"\n",(0,i.jsx)(e.li,{children:"executor (Nav2 action client)"}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"hands-on-lab-runnable-text-command--validated-plan--nav2-goal",children:"Hands-on Lab (runnable): text command \u2192 validated plan \u2192 Nav2 goal"}),"\n",(0,i.jsx)(e.p,{children:"This lab runs without Whisper/LLM. We use typed commands to prove the integration."}),"\n",(0,i.jsx)(e.h3,{id:"1-create-package",children:"1) Create package"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"cd ~/q2_ws/src\nros2 pkg create q2_vla --build-type ament_python --dependencies rclpy std_msgs geometry_msgs nav2_msgs\n"})}),"\n",(0,i.jsxs)(e.h3,{id:"2-command-input-node-stdin--vlacommand",children:["2) Command input node (stdin \u2192 ",(0,i.jsx)(e.code,{children:"/vla/command"}),")"]}),"\n",(0,i.jsxs)(e.p,{children:["Create ",(0,i.jsx)(e.code,{children:"~/q2_ws/src/q2_vla/q2_vla/command_input.py"}),":"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:'import threading\n\nimport rclpy\nfrom rclpy.node import Node\nfrom std_msgs.msg import String\n\n\nclass CommandInput(Node):\n    def __init__(self) -> None:\n        super().__init__("command_input")\n        self.pub = self.create_publisher(String, "/vla/command", 10)\n        self._thread = threading.Thread(target=self._loop, daemon=True)\n        self._thread.start()\n        self.get_logger().info("Type commands like: go kitchen | go lab | stop")\n\n    def _loop(self) -> None:\n        while rclpy.ok():\n            try:\n                line = input("> ").strip()\n            except EOFError:\n                break\n            if not line:\n                continue\n            msg = String()\n            msg.data = line\n            self.pub.publish(msg)\n\n\ndef main() -> None:\n    rclpy.init()\n    rclpy.spin(CommandInput())\n\n\nif __name__ == "__main__":\n    main()\n'})}),"\n",(0,i.jsxs)(e.h3,{id:"3-planner-node-validated-plan--vlaplan",children:["3) Planner node (validated plan \u2192 ",(0,i.jsx)(e.code,{children:"/vla/plan"}),")"]}),"\n",(0,i.jsxs)(e.p,{children:["Create ",(0,i.jsx)(e.code,{children:"~/q2_ws/src/q2_vla/q2_vla/planner.py"}),":"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:'import json\n\nimport rclpy\nfrom rclpy.node import Node\nfrom std_msgs.msg import String\n\n\nclass Planner(Node):\n    def __init__(self) -> None:\n        super().__init__("planner")\n        self.goals = {\n            "kitchen": {"x": 1.0, "y": 0.0, "yaw": 0.0},\n            "lab": {"x": 0.0, "y": 1.0, "yaw": 1.57},\n        }\n        self.sub = self.create_subscription(String, "/vla/command", self.on_cmd, 10)\n        self.pub = self.create_publisher(String, "/vla/plan", 10)\n\n    def on_cmd(self, msg: String) -> None:\n        text = msg.data.lower().strip()\n        if text.startswith("go "):\n            goal_id = text.replace("go ", "", 1).strip()\n            if goal_id not in self.goals:\n                self._publish({"type": "SAY", "text": f"Unknown goal \'{goal_id}\'"})\n                return\n            self._publish({"type": "NAVIGATE", "goal_id": goal_id, "pose": self.goals[goal_id]})\n            return\n\n        if text == "stop":\n            self._publish({"type": "STOP"})\n            return\n\n        self._publish({"type": "SAY", "text": "Try: go kitchen | go lab | stop"})\n\n    def _publish(self, plan: dict) -> None:\n        out = String()\n        out.data = json.dumps(plan)\n        self.pub.publish(out)\n\n\ndef main() -> None:\n    rclpy.init()\n    rclpy.spin(Planner())\n\n\nif __name__ == "__main__":\n    main()\n'})}),"\n",(0,i.jsxs)(e.h3,{id:"4-nav2-executor-plan--navigatetopose",children:["4) Nav2 executor (plan \u2192 ",(0,i.jsx)(e.code,{children:"NavigateToPose"}),")"]}),"\n",(0,i.jsxs)(e.p,{children:["Create ",(0,i.jsx)(e.code,{children:"~/q2_ws/src/q2_vla/q2_vla/nav2_executor.py"}),":"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:'import json\nimport math\n\nimport rclpy\nfrom rclpy.node import Node\nfrom rclpy.action import ActionClient\nfrom std_msgs.msg import String\nfrom geometry_msgs.msg import PoseStamped\nfrom nav2_msgs.action import NavigateToPose\n\n\ndef yaw_to_quat(yaw: float) -> tuple[float, float, float, float]:\n    half = yaw / 2.0\n    return (0.0, 0.0, math.sin(half), math.cos(half))\n\n\nclass Nav2Executor(Node):\n    def __init__(self) -> None:\n        super().__init__("nav2_executor")\n        self.client = ActionClient(self, NavigateToPose, "navigate_to_pose")\n        self.sub = self.create_subscription(String, "/vla/plan", self.on_plan, 10)\n\n    def on_plan(self, msg: String) -> None:\n        try:\n            plan = json.loads(msg.data)\n        except json.JSONDecodeError:\n            self.get_logger().error("Invalid JSON plan")\n            return\n\n        if plan.get("type") == "STOP":\n            self.get_logger().warn("STOP requested (no cancel implemented in this minimal lab)")\n            return\n\n        if plan.get("type") != "NAVIGATE":\n            self.get_logger().info(f"Non-nav plan: {plan}")\n            return\n\n        pose = plan.get("pose") or {}\n        goal = PoseStamped()\n        goal.header.frame_id = "map"\n        goal.header.stamp = self.get_clock().now().to_msg()\n        goal.pose.position.x = float(pose.get("x", 0.0))\n        goal.pose.position.y = float(pose.get("y", 0.0))\n        qx, qy, qz, qw = yaw_to_quat(float(pose.get("yaw", 0.0)))\n        goal.pose.orientation.x = qx\n        goal.pose.orientation.y = qy\n        goal.pose.orientation.z = qz\n        goal.pose.orientation.w = qw\n\n        self._send_goal(goal)\n\n    def _send_goal(self, goal_pose: PoseStamped) -> None:\n        if not self.client.wait_for_server(timeout_sec=2.0):\n            self.get_logger().error("Nav2 action server not available. Start Nav2 first.")\n            return\n        goal_msg = NavigateToPose.Goal()\n        goal_msg.pose = goal_pose\n        self.get_logger().info("Sending Nav2 goal...")\n        self.client.send_goal_async(goal_msg)\n\n\ndef main() -> None:\n    rclpy.init()\n    rclpy.spin(Nav2Executor())\n\n\nif __name__ == "__main__":\n    main()\n'})}),"\n",(0,i.jsx)(e.h3,{id:"5-register--build--run-with-nav2-running",children:"5) Register + build + run (with Nav2 running)"}),"\n",(0,i.jsxs)(e.p,{children:["Edit ",(0,i.jsx)(e.code,{children:"~/q2_ws/src/q2_vla/setup.py"}),":"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-python",children:'entry_points={\n    "console_scripts": [\n        "command_input = q2_vla.command_input:main",\n        "planner = q2_vla.planner:main",\n        "nav2_executor = q2_vla.nav2_executor:main",\n    ],\n},\n'})}),"\n",(0,i.jsx)(e.p,{children:"Build:"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"cd ~/q2_ws\ncolcon build --symlink-install\nsource ~/q2_ws/install/setup.bash\n"})}),"\n",(0,i.jsx)(e.p,{children:"Run nodes:"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"# Terminal C (after Chapter 8 terminals are running Nav2)\nros2 run q2_vla planner\n"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"# Terminal D\nros2 run q2_vla nav2_executor\n"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"# Terminal E\nros2 run q2_vla command_input\n"})}),"\n",(0,i.jsx)(e.p,{children:"Type:"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-text",children:"go kitchen\n"})}),"\n",(0,i.jsx)(e.h2,{id:"lab-deliverable",children:"Lab Deliverable"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["A runnable ",(0,i.jsx)(e.code,{children:"q2_vla"})," package that publishes ",(0,i.jsx)(e.code,{children:"/vla/command"})," and ",(0,i.jsx)(e.code,{children:"/vla/plan"}),", and an executor that triggers a navigation action only from validated schema JSON."]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"assessment-item",children:"Assessment Item"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"Practical prompt: provide one ambiguous voice/text command and show the \u201csafe fallback\u201d behavior your system uses."}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"hands-on-lab-optional-add-whisper--an-llm-planner",children:"Hands-on Lab (optional): add Whisper + an LLM planner"}),"\n",(0,i.jsx)(e.p,{children:"Assumptions (pick one; both are optional):"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["Speech: ",(0,i.jsx)(e.code,{children:"faster-whisper"})," (GPU optional)"]}),"\n",(0,i.jsx)(e.li,{children:"LLM: local model via Ollama, or a hosted API (requires keys + network)"}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"Guideline: keep this structure:"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-text",children:"audio -> ASR -> text -> (LLM -> schema) -> validator -> executor\n"})}),"\n",(0,i.jsx)(e.p,{children:"Minimum safety rule:"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"The executor MUST only consume validated schema JSON (never raw LLM text)."}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"nav2_executor"})," logs \u201caction server not available\u201d","\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["Nav2 isn\u2019t running, or the action name differs. Check: ",(0,i.jsx)(e.code,{children:"ros2 action list | rg navigate"}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["Robot tries to navigate to a nonsense location","\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["Your ",(0,i.jsx)(e.code,{children:"goal_id"})," \u2192 pose mapping is wrong. Make it explicit and version-controlled."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\u201cSTOP requested\u201d doesn\u2019t stop navigation","\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["You need action cancellation (",(0,i.jsx)(e.code,{children:"GoalHandle.cancel_goal_async()"}),"); implement it as an exercise."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"quick-quiz",children:"Quick Quiz"}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsx)(e.li,{children:"Why do we force the planner output into a schema before execution?"}),"\n",(0,i.jsx)(e.li,{children:"Where is the best place to implement safety constraints: ASR, LLM, or executor? Why?"}),"\n",(0,i.jsx)(e.li,{children:"What ROS primitive is best for navigation goals: topic, service, or action?"}),"\n"]})]})}function p(n={}){const{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(d,{...n})}):d(n)}},8453(n,e,a){a.d(e,{R:()=>t,x:()=>r});var l=a(6540);const i={},s=l.createContext(i);function t(n){const e=l.useContext(s);return l.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function r(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:t(n.components),l.createElement(s.Provider,{value:e},n.children)}}}]);