"use strict";(self.webpackChunkphysical_ai_humanoid_robotics_q2=self.webpackChunkphysical_ai_humanoid_robotics_q2||[]).push([[3404],{2803(e,n,s){s.r(n),s.d(n,{assets:()=>t,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"chapters/rclpy-nodes","title":"Chapter 3 \u2014 rclpy Patterns (Timers, QoS, Params, Composition)","description":"Learning Objectives","source":"@site/docs/chapters/03-rclpy-nodes.md","sourceDirName":"chapters","slug":"/chapters/rclpy-nodes","permalink":"/physical-ai-humanoid-robotics-q2/chapters/rclpy-nodes","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"title":"Chapter 3 \u2014 rclpy Patterns (Timers, QoS, Params, Composition)"},"sidebar":"tutorialSidebar","previous":{"title":"Chapter 2 \u2014 ROS 2 Fundamentals (Nodes, Topics, Services, Actions)","permalink":"/physical-ai-humanoid-robotics-q2/chapters/ros2-fundamentals"},"next":{"title":"Chapter 4 \u2014 URDF/Xacro + TF2 (Robot Model and Frames)","permalink":"/physical-ai-humanoid-robotics-q2/chapters/urdf-tf2"}}');var r=s(4848),l=s(8453);const o={title:"Chapter 3 \u2014 rclpy Patterns (Timers, QoS, Params, Composition)"},c="Chapter 3 - rclpy Patterns (Timers, QoS, Params, Composition)",t={},a=[{value:"Learning Objectives",id:"learning-objectives",level:2},{value:"Key Terms",id:"key-terms",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Concepts",id:"concepts",level:2},{value:"Timers + callbacks (why structure matters)",id:"timers--callbacks-why-structure-matters",level:3},{value:"QoS (why \u201csame topic name\u201d is not enough)",id:"qos-why-same-topic-name-is-not-enough",level:3},{value:"Hands-on Lab: latched config topic + fast sensor topic",id:"hands-on-lab-latched-config-topic--fast-sensor-topic",level:2},{value:"Lab Deliverable",id:"lab-deliverable",level:2},{value:"Assessment Item",id:"assessment-item",level:2},{value:"1) Create package",id:"1-create-package",level:3},{value:"2) Config publisher (TRANSIENT_LOCAL)",id:"2-config-publisher-transient_local",level:3},{value:"3) Fast publisher (BEST_EFFORT)",id:"3-fast-publisher-best_effort",level:3},{value:"4) Register + build + run",id:"4-register--build--run",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Quick Quiz",id:"quick-quiz",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"chapter-3---rclpy-patterns-timers-qos-params-composition",children:"Chapter 3 - rclpy Patterns (Timers, QoS, Params, Composition)"})}),"\n",(0,r.jsx)(n.h2,{id:"learning-objectives",children:"Learning Objectives"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Structure ROS nodes around short callbacks and non-blocking timers."}),"\n",(0,r.jsx)(n.li,{children:"Explain QoS tradeoffs (reliability/durability/depth) and pick profiles for sensors vs commands."}),"\n",(0,r.jsx)(n.li,{children:"Verify QoS behavior using ROS CLI tools (including late-joiner behavior)."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"key-terms",children:"Key Terms"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"callback, timer, QoS, reliability, durability, history depth, transient local, best effort"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["You can create and run ",(0,r.jsx)(n.code,{children:"ament_python"})," packages."]}),"\n",(0,r.jsxs)(n.li,{children:["You know how to inspect topics (",(0,r.jsx)(n.code,{children:"ros2 topic echo"}),", ",(0,r.jsx)(n.code,{children:"ros2 topic hz"}),")."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"concepts",children:"Concepts"}),"\n",(0,r.jsx)(n.h3,{id:"timers--callbacks-why-structure-matters",children:"Timers + callbacks (why structure matters)"}),"\n",(0,r.jsx)(n.p,{children:"ROS nodes are event-driven. You typically have:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"subscription callbacks (incoming data)"}),"\n",(0,r.jsx)(n.li,{children:"timer callbacks (periodic work)"}),"\n",(0,r.jsx)(n.li,{children:"service/action callbacks (requests/goals)"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Rule: keep callbacks short. If a callback blocks, your node becomes unresponsive."}),"\n",(0,r.jsx)(n.h3,{id:"qos-why-same-topic-name-is-not-enough",children:"QoS (why \u201csame topic name\u201d is not enough)"}),"\n",(0,r.jsx)(n.p,{children:"QoS controls how DDS delivers messages. Common knobs:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"reliability"}),": ",(0,r.jsx)(n.code,{children:"RELIABLE"})," vs ",(0,r.jsx)(n.code,{children:"BEST_EFFORT"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"durability"}),": ",(0,r.jsx)(n.code,{children:"VOLATILE"})," vs ",(0,r.jsx)(n.code,{children:"TRANSIENT_LOCAL"})," (late-joiners get last message)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"history/depth"}),": queue size"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Typical patterns:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Sensors (camera/LiDAR): ",(0,r.jsx)(n.code,{children:"BEST_EFFORT"}),", small depth"]}),"\n",(0,r.jsxs)(n.li,{children:["Commands/state: ",(0,r.jsx)(n.code,{children:"RELIABLE"})]}),"\n",(0,r.jsxs)(n.li,{children:["Static config: ",(0,r.jsx)(n.code,{children:"TRANSIENT_LOCAL"})]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"hands-on-lab-latched-config-topic--fast-sensor-topic",children:"Hands-on Lab: latched config topic + fast sensor topic"}),"\n",(0,r.jsx)(n.p,{children:'Goal: publish a "latched" config once, and publish a fast stream separately.'}),"\n",(0,r.jsx)(n.h2,{id:"lab-deliverable",children:"Lab Deliverable"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["A package ",(0,r.jsx)(n.code,{children:"q2_qos"})," that publishes ",(0,r.jsx)(n.code,{children:"/q2/config"})," as TRANSIENT_LOCAL and ",(0,r.jsx)(n.code,{children:"/q2/fast"})," at high rate, with a recorded verification showing late-join behavior for ",(0,r.jsx)(n.code,{children:"/q2/config"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"assessment-item",children:"Assessment Item"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Practical check: show ",(0,r.jsx)(n.code,{children:"ros2 topic info /q2/config -v"})," and explain why that QoS is good for config but dangerous for high-rate sensor streams."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"1-create-package",children:"1) Create package"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cd ~/q2_ws/src\nros2 pkg create q2_qos --build-type ament_python --dependencies rclpy std_msgs\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2-config-publisher-transient_local",children:"2) Config publisher (TRANSIENT_LOCAL)"}),"\n",(0,r.jsxs)(n.p,{children:["Create ",(0,r.jsx)(n.code,{children:"~/q2_ws/src/q2_qos/q2_qos/config_pub.py"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'import rclpy\nfrom rclpy.node import Node\nfrom rclpy.qos import DurabilityPolicy, QoSProfile, ReliabilityPolicy\nfrom std_msgs.msg import String\n\n\nclass ConfigPublisher(Node):\n    def __init__(self) -> None:\n        super().__init__("config_publisher")\n        qos = QoSProfile(\n            depth=1,\n            reliability=ReliabilityPolicy.RELIABLE,\n            durability=DurabilityPolicy.TRANSIENT_LOCAL,\n        )\n        self.pub = self.create_publisher(String, "/q2/config", qos)\n        msg = String()\n        msg.data = "mode=training; max_speed=1.0"\n        self.pub.publish(msg)\n        self.get_logger().info("Published latched config once; keep node running for discovery.")\n\n\ndef main() -> None:\n    rclpy.init()\n    node = ConfigPublisher()\n    rclpy.spin(node)\n\n\nif __name__ == "__main__":\n    main()\n'})}),"\n",(0,r.jsx)(n.h3,{id:"3-fast-publisher-best_effort",children:"3) Fast publisher (BEST_EFFORT)"}),"\n",(0,r.jsxs)(n.p,{children:["Create ",(0,r.jsx)(n.code,{children:"~/q2_ws/src/q2_qos/q2_qos/fast_pub.py"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'import time\n\nimport rclpy\nfrom rclpy.node import Node\nfrom rclpy.qos import QoSProfile, ReliabilityPolicy\nfrom std_msgs.msg import String\n\n\nclass FastPublisher(Node):\n    def __init__(self) -> None:\n        super().__init__("fast_publisher")\n        qos = QoSProfile(depth=5, reliability=ReliabilityPolicy.BEST_EFFORT)\n        self.pub = self.create_publisher(String, "/q2/fast", qos)\n        self.timer = self.create_timer(0.01, self.on_tick)  # 100 Hz\n        self.counter = 0\n\n    def on_tick(self) -> None:\n        self.counter += 1\n        msg = String()\n        msg.data = f"{self.counter} {time.time():.3f}"\n        self.pub.publish(msg)\n\n\ndef main() -> None:\n    rclpy.init()\n    rclpy.spin(FastPublisher())\n\n\nif __name__ == "__main__":\n    main()\n'})}),"\n",(0,r.jsx)(n.h3,{id:"4-register--build--run",children:"4) Register + build + run"}),"\n",(0,r.jsxs)(n.p,{children:["Edit ",(0,r.jsx)(n.code,{children:"~/q2_ws/src/q2_qos/setup.py"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'entry_points={\n    "console_scripts": [\n        "config_pub = q2_qos.config_pub:main",\n        "fast_pub = q2_qos.fast_pub:main",\n    ],\n},\n'})}),"\n",(0,r.jsx)(n.p,{children:"Build:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cd ~/q2_ws\ncolcon build --symlink-install\nsource ~/q2_ws/install/setup.bash\n"})}),"\n",(0,r.jsx)(n.p,{children:"Run config publisher:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Terminal A\nros2 run q2_qos config_pub\n"})}),"\n",(0,r.jsx)(n.p,{children:"Now start a late-joining echo:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Terminal B (start this after A is already running)\nros2 topic echo /q2/config --once\n"})}),"\n",(0,r.jsx)(n.p,{children:"Measure fast topic rate:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"ros2 topic hz /q2/fast\n"})}),"\n",(0,r.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Late-joining ",(0,r.jsx)(n.code,{children:"echo"})," shows nothing for ",(0,r.jsx)(n.code,{children:"/q2/config"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["You used default QoS somewhere. Verify durability via:\n",(0,r.jsx)(n.code,{children:"ros2 topic info /q2/config -v"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"/q2/fast"})," rate is much lower than expected","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Your machine is loaded; reduce to 50 Hz and confirm."}),"\n",(0,r.jsx)(n.li,{children:"Python timers are not hard real-time; don\u2019t assume exact periods."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"quick-quiz",children:"Quick Quiz"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Why is ",(0,r.jsx)(n.code,{children:"TRANSIENT_LOCAL"})," useful for \u201cconfig\u201d but dangerous for high-rate topics?"]}),"\n",(0,r.jsxs)(n.li,{children:["When would you pick ",(0,r.jsx)(n.code,{children:"BEST_EFFORT"})," over ",(0,r.jsx)(n.code,{children:"RELIABLE"}),"?"]}),"\n",(0,r.jsx)(n.li,{children:"What is the practical difference between \u201ctimer-based\u201d and \u201cevent-based\u201d work?"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453(e,n,s){s.d(n,{R:()=>o,x:()=>c});var i=s(6540);const r={},l=i.createContext(r);function o(e){const n=i.useContext(l);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(l.Provider,{value:n},e.children)}}}]);